---
title: "Technical background to the simsurv package"
author: "Sam Brilleman"
date: "`r Sys.Date()`"
output: 
  html_vignette:
    toc: yes
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Technical background to the simsurv package}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

To simulate survival data, a common approach has been to make simplifying parametric assumptions about the distribution of event times. For example, many authors have limited their simulation studies to settings in which the simulated event times are drawn from exponential or Weibull distributions. However, the exponential and Weibull distributions may be unrealistic in many settings, since they respectively assume a constant and monotonically increasing hazard function. These limiting forms for the hazard function are likely to be implausible in many health related applications.

A more general method was proposed by Bender et al. (2005) [1] and is referred to herein as the cumulative hazard inversion method. This method allows one to simulate event times under a proportional hazards model data generating process for any parametric baseline hazard function. This includes as special cases the exponential, Weibull and Gompertz distributions. However, it also provides a much more general framework that can be extended beyond those standard parametric distributions.



## Simulating survival probabilities for known parametric distributions

The survival function for individual $i$ is the probability that their “true” event time $T_i^*$ is greater than the current time $t$. That is, the survival function can be defined as

\begin{align}
  S_i (t) = P(T_i^* > t)
\end{align}

Moreover, the corresponding probability of having failed at or before time $t$ (i.e. having not survived up to time $t$) is the complement to the survival function. That is, the probability of failure is defined as

\begin{align}
  F_i (t) = P(T_i^* \leq t) = 1 - S_i (t)
\label{eq:failprob}
\end{align}

If the survival time $T_i^*$ is known to be drawn from some parametric distribution, then it also holds that the definition of the probability of failure in equation $\eqref{eq:failprob}$ is equivalent to the definition of the cumulative distribution function (CDF) for the distribution of event times. Moreover, probability distribution theory tells us that the CDF for a continuous random variable must follow a uniform distribution on the range 0 to 1 [ref #25 from Bender]. That is, $F_X (X) \sim U(0,1)$ where $F_X (.)$ denotes the CDF for the continuous random variable $X$. Similarly, the complement of the CDF for $X$ must also follow a uniform distribution on the range 0 to 1, that is, $1-F_X (X) \sim U(0,1)$.

These results therefore allow one to conclude that under a standard parametric distributional assumption for the event times $T_i^*$ $(i=1,…,N)$, the survival probability for individual $i$ at their true event time will be a uniform random variable on the range 0 to 1. That is, 

\begin{align}
  S_i (T_i^*) = U_i \sim U(0,1)
\end{align}

## Extending to the proportional hazards data generating process

It is then possible to extend these results to the setting of a proportional hazards model. Under a proportional hazards model the survival probability for individual $i$ at their event time $T_i^*$ can be written as 

\begin{align}
  S_i (T_i^*) = \exp \left( -H_0 (T_i^*) \exp(X_i^T \beta) \right) = U_i \sim U(0,1)
\end{align}

where $H_0(t)=\int_0^t h_0(s) ds$ is the cumulative baseline hazard evaluated at time $t$. Since the objective is to simulate new event times $T_i^s$ $(i=1,…,N)$ one needs to rearrange equation $X$ to solve for the event time. The equation resulting from this rearrangement is described in the next section.

## Cumulative hazard inversion method

Using the cumulative hazard inversion method one can easily simulate a survival time  by drawing a uniform random variable $U_i \sim U(0,1)$ and evaluating

Rearranging the equation from the previous section to solve for $T_i$ leads the following general form:

\begin{equation}
  T_i^s = H_0^{-1} \left[ -\log(U_i) \exp(X_i^T \beta) \right]
\label{eq:bender_formula}
\end{equation}

where $T_i^s$ is the simulated event time for individual $i$, $H_0^{-1} [.]$ corresponds to the inverted cumulative baseline hazard, $X_i$ is a vector of covariates with associated population-level (i.e. fixed effect) parameters $\beta$, and $U_i$ is a random variable drawn from a $U(0,1)$ distribution.

Therefore, all that is required to generate the simulated event time is an independent draw of the random uniform variable $U_i$ and an invertible cumulative baseline hazard function. If the cumulative baseline hazard is invertible then an analytical for will be available for this equation. In particular we can show the analytical form for the Weibull, exponential and Gompertz distributions under the parameterisations used in **simsurv**.

### Weibull distribution

For the Weibull distribution we have the following:

$$
  h_i(t) = \gamma \lambda (t ^{\gamma - 1}) \exp(X_i^T \beta)
$$

$$
  H_i(t) = \lambda (t^{\gamma}) \exp(X_i^T \beta)
$$

$$
  S_i(t) = \exp \left( \frac{-\lambda (t^{\gamma})}{\exp(X_i^T \beta)} \right)
$$

$$
  T_i^s = \left( 
    - (\lambda^{-1}) \log(U_i) \exp(X_i^T \beta)
  \right) 
  ^ {\frac{1}{\gamma}}
$$

### Exponential distribution

For the exponential distribution we have the following:

$$
  h_i(t) = \lambda \exp(X_i^T \beta)
$$

$$
  H_i(t) = \lambda t \exp(X_i^T \beta)
$$

$$
  S_i(t) = \exp \left( -\lambda t \exp(X_i^T \beta) \right)
$$

$$
  T_i^s = \left( 
    \frac{- \log(U_i)}{\lambda \exp(X_i^T \beta)}
  \right)
$$

### Gompertz distribution

solution to the inverse of the cumulative baseline hazard can be obtained, then the method is both simple and computationally efficient. The intuition behind this method is described next.

the general equation resulting from the rearrangement was shown previously in equation $\ref{eq:bender_formula}$. 



If the cumulative baseline hazard is invertible, then we can find an analytic form for the equation in However, we can also show the rearrangment specifically for each of the standard p

The specific inverted c

## Extending to complex data generating processes

If one can obtain an algebraic closed-form solution for the inverse cumulative baseline hazard, $H_0^{-1} (.)$, then a major benefit of the cumulative hazard inversion method is that it is simple and computationally efficient. Moreover, it can be used to generate survival times for a variety of standard parametric baseline hazards, for example, the exponential, Weibull or Gompertz distributions. 

However, two potential hurdles can be encountered when applying the method to complex data generating processes. Firstly, one may not be able to obtain a closed-form solution to the cumulative baseline hazard $H_0 (t)$. Secondly, the cumulative baseline hazard may not be invertible. Crowther and Lambert (2013) [2] therefore proposed an extension to overcome these two difficulties. Their extension incorporates univariate root finding and/or numerical quadrature. 

The root finding is used to numerically invert the cumulative hazard function in situations where it cannot be analytically inverted. For example, in their paper, Crowther and Lambert describe a two-component mixture Weibull distribution for which they are unable to invert the cumulative baseline hazard and therefore require iterative root finding techniques to obtain a solution. 

The numerical quadrature is used to numerically evaluate the cumulative hazard function in situations where there is no closed-form solution. For example, in their paper, Crowther and Lambert describe a flexible baseline hazard function that incorporates fractional polynomial terms and therefore has no closed-form solution for the cumulative baseline hazard. 

In some situations, both numerical root finding and the numerical quadrature (i.e. numerical integration) are required, and so their approach involves iterating between the two until an appropriate numerical solution to the simulated event time is obtained. This is the method used by the **simsurv** package when the user supplies their own hazard or log hazard function for generating the event times. For further details on the method we refer the reader to the the paper by Crowther and Lambert (2013) [2].

## References

1. Bender R, Augustin T, Blettner M. Generating survival times to simulate Cox proportional hazards models. *Stat Med* 2005;**24**(11):1713-1723. \doi:10.1002/sim.2059

2. Crowther MJ, Lambert PC. Simulating biologically plausible complex survival data. *Stat Med* 2013;**32**(23):4118-4134. \doi:10.1002/sim.5823

3. Crowther MJ, Lambert PC. Simulating complex survival data. *Stata J* 2012;**12**(4):674-687.

