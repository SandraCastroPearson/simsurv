---
title: "Simulate Survival Data"
author: "Sam Brilleman"
date: "`r Sys.Date()`"
output: 
  html_vignette:
    toc: yes
params:
  EVAL: !r identical(Sys.getenv("NOT_CRAN"), "true")
---
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{simsurv: Simulate Survival Data}
-->

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load packages
library(simsurv)
library(flexsurv)
```

This vignette provides an introduction to the **simsurv** package. The package allows the user to simulate survival times from standard parametric survival distributions (exponential, Weibull, Gompertz), 2-component mixture distributions, or a user-defined hazard or log hazard function. Baseline covariates can be included under a proportional hazards assumption. Time dependent effects (i.e. non-proportional hazards) can be included by interacting covariates with linear time or some transformation of time. 

## Background

To be completed.

## Examples

Note: The following examples are loosely based on the supporting article for the **survsim** Stata package; see Crowther and Lambert (2012) [1]. In addition, we will be using the **flexsurv** package to fit several of the survival models discussed below. This will allow us to fit both standard (e.g. Weibull) and flexible parametric survival models to either real or simulated datasets. 

### Standard parametric survival model

We will first show how the **simsurv** package can be used to simulate survival times under a Weibull proportional hazards model. We will do this as part of a relatively simple simulation study. Our objective will be to simulate survival times under the following conditions. First, we will assume a monotonically increasing baseline hazard function, achieved by specifying a Weibull baseline hazard with a $\gamma$ parameter of 1.5. Second, we will incorporate the effect of a protective treatment by specifying a binary covariate with log hazard ratio of -0.5. Third, we will set a maximum follow up time by censoring any individuals with a simulated survival time larger than five years. Under these assumed conditions, we will generate 500 simulated datasets, each containing $N = 200$ individuals. We will analyse the results of the simulation study by fitting a Weibull proportional hazards model to each simulated dataset using the `flexsurvspline` function from the **flexsurv** package, and then calculating bias and coverage of the estimated treatment effect.

The following steps are required to perform the simulation study:

1. First we define a function that will simulate covariate data for one dataset of $N = 200$ individuals, simulate the event or censoring time for each individual, fit the Weibull proportional hazards model, and then return the bias in the estimated treatment effect and an indicator of coverage for the 95% confidence interval. Each line of this function is described in the code below. 

```{r, sim_run_define}
sim_run <- function() {
  # Create a data frame with the subject IDs and treatment covariate
  cov <- data.frame(id = 1:200, trt = rbinom(200, 1, 0.5))
  
  # Simulate the event times
  dat <- simsurv(lambdas = 0.1, gammas = 1.5, betas = c(trt = -0.5), x = cov, maxt = 5)
  
  # Merge the simulated event times onto covariate data frame
  dat <- merge(cov, dat)
  
  # Fit a Weibull proportional hazards model
  mod <- flexsurvspline(Surv(eventtime, status) ~ trt, data = dat)
  
  # Obtain estimates, standard errors and 95% CI limits for treatment effect
  est <- mod$coefficients[["trt"]]
  ses <- sqrt(diag(mod$cov))[["trt"]]
  cil <- est + qnorm(.025) * ses
  ciu <- est + qnorm(.975) * ses
  
  # Return bias and coverage indicator for treatment effect
  c(bias = est - (-0.5), 
    coverage = ((-0.5 > cil) && (-0.5 < ciu)))
}
```

2. Next we call our simulation function 1000 times using the `replicate` function and calculate the mean bias and coverage.

```{r, sim_run_replicate}
set.seed(908070)
rowMeans(replicate(500, sim_run()))
```

Here we see that there is very little bias in the estimates of the log hazard ratio for the treatment effect, and the 95% confidence intervals are near their intended level of coverage.

### Flexible parametric survival model

Next, we will simulate data under a more flexible parametric baseline hazard. This will result in a baseline hazard function that is more realistic for a given setting. To demonstrate this, we will use the freely available German breast cancer data. This data is included as an example dataset with the **simsurv** package. 

We will first load the dataset and then fit two models, one with a Weibull baseline hazard and one using a flexible parametric baseline hazard (using the method of Royston and Parmar, with a spline-based log cumulative baseline hazard). The argument `k` specifies the number of knots to use for the flexible parametric survival model; by setting `k` equal to zero, this is equivalent to the Weibull proportional hazards model. We can then compare the fit of the two models by plotting their fitted survival functions overlaid on the Kaplan-Meier survival function.

```{r, brcancer_fits}
data("brcancer")
mod1 <- flexsurvspline(Surv(rectime, censrec) ~ hormon, data = brcancer, k = 0)
mod2 <- flexsurvspline(Surv(rectime, censrec) ~ hormon, data = brcancer, k = 3)
par(mfrow = c(1,2))
plot(mod1)
plot(mod2)
```

There is evidence in the plots that the flexible parametric model fits the data better than the standard Weibull model. Therefore, if we wanted to simulate survival times from a data generating process similar to that of the breast cancer data, then using a Weibull distribution may not be adequate. Rather, it would be more appropriate to similar survival times under a flexible parametric survival model. We will therefore demonstrate how `simsurv` can be used to do this. 

We will use the estimated parameters from the flexible parametric survival model as the "true" parameters for our simulated data. Moreover we will generate the survival times under a user-specified log cumulative hazard function that is equivalent to the Royston and Parmar specification used by the **flexsurv** package.

Let us first define our log cumulative hazard function from which we wish to generate our survival times.

```{r, define_logcumhaz}
logcumhaz <- function(t, x, betas, knots) {
  # Obtain the basis terms for the spline-based log
  # cumulative hazard (evaluated at time t)
  basis <- flexsurv::basis(knots, log(t))
  
  # Evaluate the log cumulative hazard under the
  # Royston and Parmar specification
  res <- 
    betas[["gamma0"]] * basis[[1]] + 
    betas[["gamma1"]] * basis[[2]] +
    betas[["gamma2"]] * basis[[3]] +
    betas[["gamma3"]] * basis[[4]] +
    betas[["gamma4"]] * basis[[5]] +
    betas[["hormon"]] * x[["hormon"]]
  res
}
```

Next, we will show how to use the `simsurv` function to simulate survival times, passing in the log cumulative hazard function we just defined (`logcumhazard`), the vector true parameter values (`betas`), and the data frame with the observed covariate data (`x`). The vector of true parameter values will include the coefficients for the spline-based log cumulative baseline hazard. The data frame of covariate data will only include the subject IDs and the indicator variable for hormone therapy (the latter will be simulated as bernoulli random variable with probability of 0.5).

We will perform a simulation study to assess how well the Weibull and flexible parametric survival models fit our simulated data, by assessing the level of bias in the estimated effect for hormone therapy across 500 simulated datasets.

```{r, sim_for_logcumhaz}
# Fit the model to the brcancer dataset to obtain the "true"
# parameter values that will be used in our simulation study
true_mod <- flexsurvspline(Surv(rectime, censrec) ~ hormon, data = brcancer, k = 3)

sim_run <- function(true_mod) {
  # Create a data frame with the subject IDs and treatment covariate
  cov <- data.frame(id = 1:200, hormon = rbinom(200, 1, 0.5))

  # Simulate the event times
  dat <- simsurv(betas = true_mod$coefficients, # "true" parameter values
                 x = cov,                   # covariate data for 200 individuals
                 knots = true_mod$knots,    # knot locations for splines
                 logcumhazard = logcumhaz,  # definition of log cum hazard
                 maxt = NULL,               # no right-censoring
                 interval = c(1E-8,100000)) # interval for root finding
  
  # Merge the simulated event times onto covariate data frame
  dat <- merge(cov, dat)

  # Fit a Weibull proportional hazards model
  weib_mod <- flexsurvspline(Surv(eventtime, status) ~ hormon, data = dat, k = 0)
  flex_mod <- flexsurvspline(Surv(eventtime, status) ~ hormon, data = dat, k = 3)
  
  # Obtain estimates, standard errors and 95% CI limits for hormone effect
  true_loghr <- true_mod$coefficients[["hormon"]]
  weib_loghr <- weib_mod$coefficients[["hormon"]]
  flex_loghr <- flex_mod$coefficients[["hormon"]]
 
  # Return bias and coverage indicator for hormone effect
  c(weib_bias = weib_loghr - true_loghr, 
    flex_bias = flex_loghr - true_loghr)
}

# Simulat
set.seed(543543)
rowMeans(replicate(500, sim_run(true_mod = true_mod)))
```

# References

1. Crowther MJ, Lambert PC. Simulating complex survival data. *Stata J* 2012;**12**(4):674-687.

